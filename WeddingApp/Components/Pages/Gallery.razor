@using Microsoft.Extensions.Logging
@inject IWebHostEnvironment Environment
@using System.Net.Http.Headers
@using System.Text.Json
@using WeddingApp.Components.Elements
@using WeddingApp.Controllers
@using WeddingApp.Entities
@inject IHttpClientFactory ClientFactory
@inject FilesController FilesController
@inject CustomAuthState CustomAuthState

<MudAppBar Color="Color.Primary">
    @* <MudFileUpload T="IReadOnlyList<IBrowserFile>" Context="fileInput" FilesChanged="OnInputFileChange" Accept="image/*">
        <ButtonTemplate>
            <MudIconButton HtmlTag="label"
                           Color="Color.Info"
                           Icon="@Icons.Material.Filled.PhotoCamera"
                           for="@fileInput">
            </MudIconButton>
        </ButtonTemplate>
    </MudFileUpload> *@
     <MudFileUpload T="IReadOnlyList<IBrowserFile>" Context="fileInput" FilesChanged="OnInputFileChange" Accept="image/*">
        <ButtonTemplate>
            <MudButton HtmlTag="label"
                       Variant="Variant.Filled"
                       Color="Color.Primary"
                       StartIcon="@Icons.Material.Filled.PhotoCamera"
                       for="@fileInput.Id">
                Dodaj zdjęcie
            </MudButton>
        </ButtonTemplate>
    </MudFileUpload> 
    @if (isLoading)
    {
        <MudProgressLinear Color="Color.Secondary" Striped="true" Value="@(Convert.ToDouble(progressPercent)*100)" Class="my-7">
            <MudText Typo="Typo.subtitle1" Color="Color.Dark">
                <b>@(Convert.ToDouble(progressPercent) * 100)%</b>
            </MudText>
        </MudProgressLinear>
    }
</MudAppBar>


<MudStack Row="true" Wrap="Wrap.Wrap" Spacing="1" Justify="Justify.Center" AlignItems="AlignItems.Center">
    @foreach (PictureEntity picture in pictures)
    {
        <Picture pictureEntity="picture" CurrentUserID="CustomAuthState.CurrentUserEntity.UserID" DeletePicture="@DeletePicture" />
    }
</MudStack>




@code {
    public List<PictureEntity> pictures = new();
    MudGallery? _gallery;
    private bool isLoading;
    private bool shouldRender;
    public int readbytes;
    private decimal progressPercent;
    public string uploadDirectory;
    public string statusMessage;

    protected override Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            pictures = FilesController.LoadFiles().Result;
            StateHasChanged();
        }
        return base.OnAfterRenderAsync(firstRender);
    }

    private async Task OnInputFileChange(IReadOnlyList<IBrowserFile> inputFileChangeEventArgs)
    {
        isLoading = true;
        FilesController.OnStateChange += UploadingPictureProgress;
        await FilesController.UploadFiles(
            inputFileChangeEventArgs,
            CustomAuthState.CurrentUserEntity.UserID);
        FilesController.OnStateChange -= UploadingPictureProgress;
        isLoading = false;
        pictures = FilesController.LoadFiles().Result;
        StateHasChanged();
    }

    private async void UploadingPictureProgress(decimal progressPercent)
    {
        this.progressPercent = progressPercent;
        await InvokeAsync(() => StateHasChanged());
    }

    private async Task DeletePicture(string pathToPicture)
    {
        await FilesController.DeletePicture(pathToPicture);
        pictures = FilesController.LoadFiles().Result;
        StateHasChanged();
    }
}
